"use strict";
/*
 * Copyright 2023 Amazon.com, Inc. or its affiliates.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.MRTesting = exports.MRTestingConfig = void 0;
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_kinesis_1 = require("aws-cdk-lib/aws-kinesis");
const aws_s3_1 = require("aws-cdk-lib/aws-s3");
const aws_s3_deployment_1 = require("aws-cdk-lib/aws-s3-deployment");
const aws_sns_subscriptions_1 = require("aws-cdk-lib/aws-sns-subscriptions");
const constructs_1 = require("constructs");
const osml_bucket_1 = require("../osml/osml_bucket");
const osml_container_1 = require("../osml/osml_container");
const osml_queue_1 = require("../osml/osml_queue");
const osml_repository_1 = require("../osml/osml_repository");
const osml_sm_endpoint_1 = require("../osml/osml_sm_endpoint");
const mr_sm_role_1 = require("./mr_sm_role");
// mutable configuration dataclass for the model runner testing Construct
// for a more detailed breakdown of the configuration see: configuration_guide.md in the documentation directory.
class MRTestingConfig {
    constructor(
    // queue names
    SQS_IMAGE_STATUS_QUEUE = "ImageStatusQueue", SQS_REGION_STATUS_QUEUE = "RegionStatusQueue", 
    // sagemaker names
    SM_CENTER_POINT_MODEL = "centerpoint", SM_FLOOD_MODEL = "flood", SM_AIRCRAFT_MODEL = "aircraft", SM_ROLE_NAME = "OSMLSageMakerRole", SM_INITIAL_INSTANCE_COUNT = 1, SM_INITIAL_VARIANT_WEIGHT = 1, SM_VARIANT_NAME = "AllTraffic", SM_CPU_INSTANCE_TYPE = "ml.m5.xlarge", SM_GPU_INSTANCE_TYPE = "ml.p3.2xlarge", 
    // bucket names
    S3_RESULTS_BUCKET = "test-results", S3_IMAGE_BUCKET = "test-images", 
    // path to test images
    S3_TEST_IMAGES_PATH = "assets/images", 
    // ecr repo names
    ECR_CENTERPOINT_MODEL_REPOSITORY = "centerpoint-model-container", ECR_FLOOD_MODEL_REPOSITORY = "flood-model-container", ECR_AIRCRAFT_MODEL_REPOSITORY = "aircraft-model-container", 
    // path to the control model source
    ECR_MODELS_PATH = "lib/models", 
    // build target for control model container
    ECR_MODEL_TARGET = "osml_model") {
        this.SQS_IMAGE_STATUS_QUEUE = SQS_IMAGE_STATUS_QUEUE;
        this.SQS_REGION_STATUS_QUEUE = SQS_REGION_STATUS_QUEUE;
        this.SM_CENTER_POINT_MODEL = SM_CENTER_POINT_MODEL;
        this.SM_FLOOD_MODEL = SM_FLOOD_MODEL;
        this.SM_AIRCRAFT_MODEL = SM_AIRCRAFT_MODEL;
        this.SM_ROLE_NAME = SM_ROLE_NAME;
        this.SM_INITIAL_INSTANCE_COUNT = SM_INITIAL_INSTANCE_COUNT;
        this.SM_INITIAL_VARIANT_WEIGHT = SM_INITIAL_VARIANT_WEIGHT;
        this.SM_VARIANT_NAME = SM_VARIANT_NAME;
        this.SM_CPU_INSTANCE_TYPE = SM_CPU_INSTANCE_TYPE;
        this.SM_GPU_INSTANCE_TYPE = SM_GPU_INSTANCE_TYPE;
        this.S3_RESULTS_BUCKET = S3_RESULTS_BUCKET;
        this.S3_IMAGE_BUCKET = S3_IMAGE_BUCKET;
        this.S3_TEST_IMAGES_PATH = S3_TEST_IMAGES_PATH;
        this.ECR_CENTERPOINT_MODEL_REPOSITORY = ECR_CENTERPOINT_MODEL_REPOSITORY;
        this.ECR_FLOOD_MODEL_REPOSITORY = ECR_FLOOD_MODEL_REPOSITORY;
        this.ECR_AIRCRAFT_MODEL_REPOSITORY = ECR_AIRCRAFT_MODEL_REPOSITORY;
        this.ECR_MODELS_PATH = ECR_MODELS_PATH;
        this.ECR_MODEL_TARGET = ECR_MODEL_TARGET;
    }
}
exports.MRTestingConfig = MRTestingConfig;
class MRTesting extends constructs_1.Construct {
    /**
     * Creates an MRTesting construct.
     * @param scope the scope/stack in which to define this construct.
     * @param id the id of this construct within the current scope.
     * @param props the properties of this construct.
     * @returns the MRTesting construct.
     */
    constructor(scope, id, props) {
        super(scope, id);
        // check if a custom config was provided
        if (props.mrTestingConfig != undefined) {
            // import existing pass in MR configuration
            this.mrTestingConfig = props.mrTestingConfig;
        }
        else {
            // create a new default configuration
            this.mrTestingConfig = new MRTestingConfig();
        }
        // setup a removal policy
        this.removalPolicy = props.account.prodLike
            ? aws_cdk_lib_1.RemovalPolicy.RETAIN
            : aws_cdk_lib_1.RemovalPolicy.DESTROY;
        // bucket to store images in
        this.imageBucket = new osml_bucket_1.OSMLBucket(this, `OSMLTestImageBucket`, {
            bucketName: `${this.mrTestingConfig.S3_IMAGE_BUCKET}-${props.account.id}`,
            prodLike: props.account.prodLike,
            removalPolicy: this.removalPolicy
        });
        // deploy test images into bucket
        new aws_s3_deployment_1.BucketDeployment(this, "OSMLTestImageDeployment", {
            sources: [aws_s3_deployment_1.Source.asset(this.mrTestingConfig.S3_TEST_IMAGES_PATH)],
            destinationBucket: this.imageBucket.bucket,
            accessControl: aws_s3_1.BucketAccessControl.BUCKET_OWNER_FULL_CONTROL,
            memoryLimit: 10240,
            useEfs: true,
            vpc: props.vpc
        });
        // bucket to store rest results in
        this.resultsBucket = new osml_bucket_1.OSMLBucket(this, `OSMLTestResultsBucket`, {
            bucketName: `${this.mrTestingConfig.S3_RESULTS_BUCKET}-${props.account.id}`,
            prodLike: props.account.prodLike,
            removalPolicy: this.removalPolicy
        });
        // a simple provisioned stream for testing the kinesis sink
        this.resultStream = new aws_kinesis_1.Stream(this, "TestStream", {
            streamName: `test-stream-${props.account.id}`,
            streamMode: aws_kinesis_1.StreamMode.PROVISIONED,
            shardCount: 1
        });
        // check if a role was provided
        if (props.smRole != undefined) {
            // import passed in MR task role
            this.smRole = props.smRole;
        }
        else {
            // create a new role
            this.smRole = new mr_sm_role_1.MRSMRole(this, "MRSMRole", {
                account: props.account,
                roleName: this.mrTestingConfig.SM_ROLE_NAME
            }).role;
        }
        if (props.deployCenterpointModel !== false) {
            if (props.centerpointModelUri !== undefined) {
                // import the image asset passed in
                this.centerPointModelImageAsset = props.centerpointModelUri;
            }
            else {
                // build a new repository for the centerpoint model
                this.centerPointModelRepository = new osml_repository_1.OSMLRepository(this, "MRCenterpointModelRepository", {
                    repositoryName: this.mrTestingConfig.ECR_CENTERPOINT_MODEL_REPOSITORY,
                    removalPolicy: this.removalPolicy
                });
                // build and deploy centerpoint model container to target repo
                this.centerPointModelImageAsset = new osml_container_1.OSMLECRContainer(this, "MRCenterPointModelContainer", {
                    directory: this.mrTestingConfig.ECR_MODELS_PATH,
                    target: this.mrTestingConfig.ECR_MODEL_TARGET,
                    repository: this.centerPointModelRepository.repository
                }).imageAsset.imageUri;
            }
            // build an SM endpoint from the centerpoint model container
            this.centerPointModelEndpoint = new osml_sm_endpoint_1.OSMLSMEndpoint(this, "OSMLCenterPointModelEndpoint", {
                modelContainerUri: this.centerPointModelImageAsset,
                modelName: this.mrTestingConfig.SM_CENTER_POINT_MODEL,
                roleArn: this.smRole.roleArn,
                instanceType: this.mrTestingConfig.SM_CPU_INSTANCE_TYPE,
                initialInstanceCount: this.mrTestingConfig.SM_INITIAL_INSTANCE_COUNT,
                initialVariantWeight: this.mrTestingConfig.SM_INITIAL_VARIANT_WEIGHT,
                variantName: this.mrTestingConfig.SM_VARIANT_NAME
            });
        }
        if (props.deployFloodModel != false) {
            if (props.floodModelUri != undefined) {
                // import the image asset passed in
                this.floodModelImageAsset = props.floodModelUri;
            }
            else {
                // build a new repository for the flood model
                this.floodModelRepository = new osml_repository_1.OSMLRepository(this, "MRFloodModelRepository", {
                    repositoryName: this.mrTestingConfig.ECR_FLOOD_MODEL_REPOSITORY,
                    removalPolicy: this.removalPolicy
                });
                // build and deploy flood model container to target repo
                this.floodModelImageAsset = new osml_container_1.OSMLECRContainer(this, "MRFloodModelContainer", {
                    directory: this.mrTestingConfig.ECR_MODELS_PATH,
                    target: this.mrTestingConfig.ECR_MODEL_TARGET,
                    repository: this.floodModelRepository.repository,
                    buildArgs: { MODEL_SELECTION: "flood" }
                }).imageAsset.imageUri;
            }
            // build an SM endpoint from the flood model container
            this.floodModelEndpoint = new osml_sm_endpoint_1.OSMLSMEndpoint(this, "OSMLFloodModelEndpoint", {
                modelContainerUri: this.floodModelImageAsset,
                modelName: this.mrTestingConfig.SM_FLOOD_MODEL,
                roleArn: this.smRole.roleArn,
                instanceType: this.mrTestingConfig.SM_CPU_INSTANCE_TYPE,
                initialInstanceCount: this.mrTestingConfig.SM_INITIAL_INSTANCE_COUNT,
                initialVariantWeight: this.mrTestingConfig.SM_INITIAL_VARIANT_WEIGHT,
                variantName: this.mrTestingConfig.SM_VARIANT_NAME
            });
        }
        if (props.deployAircraftModel != false) {
            if (props.aircraftModelUri != undefined) {
                // import the image asset passed in
                this.aircraftModelImageAsset = props.aircraftModelUri;
            }
            else {
                // build a new repository for the aircraft model
                this.aircraftModelRepository = new osml_repository_1.OSMLRepository(this, "MRAircraftModelRepository", {
                    repositoryName: this.mrTestingConfig.ECR_AIRCRAFT_MODEL_REPOSITORY,
                    removalPolicy: this.removalPolicy
                });
                // build and deploy aicraft model container to target repo
                this.aircraftModelImageAsset = new osml_container_1.OSMLECRContainer(this, "MRAircraftModelContainer", {
                    directory: this.mrTestingConfig.ECR_MODELS_PATH,
                    target: this.mrTestingConfig.ECR_MODEL_TARGET,
                    repository: this.aircraftModelRepository.repository,
                    buildArgs: { MODEL_SELECTION: "aircraft" }
                }).imageAsset.imageUri;
            }
            // build an SM endpoint from the aircraft model container
            this.aircraftModelEndpoint = new osml_sm_endpoint_1.OSMLSMEndpoint(this, "OSMLAircraftModelEndpoint", {
                modelContainerUri: this.aircraftModelImageAsset,
                modelName: this.mrTestingConfig.SM_AIRCRAFT_MODEL,
                roleArn: this.smRole.roleArn,
                instanceType: this.mrTestingConfig.SM_GPU_INSTANCE_TYPE,
                initialInstanceCount: this.mrTestingConfig.SM_INITIAL_INSTANCE_COUNT,
                initialVariantWeight: this.mrTestingConfig.SM_INITIAL_VARIANT_WEIGHT,
                variantName: this.mrTestingConfig.SM_VARIANT_NAME
            });
        }
        // create an SQS queue for region status processing updates
        this.regionStatusQueue = new osml_queue_1.OSMLQueue(this, "OSMLRegionStatusQueue", {
            queueName: this.mrTestingConfig.SQS_REGION_STATUS_QUEUE
        });
        // subscribe the region status topic to the queue
        props.regionStatusTopic.addSubscription(new aws_sns_subscriptions_1.SqsSubscription(this.regionStatusQueue.queue));
        // create an SQS queue for image processing status updates
        this.imageStatusQueue = new osml_queue_1.OSMLQueue(this, "OSMLImageStatusQueue", {
            queueName: this.mrTestingConfig.SQS_IMAGE_STATUS_QUEUE
        });
        // subscribe the image status topic to the queue
        props.imageStatusTopic.addSubscription(new aws_sns_subscriptions_1.SqsSubscription(this.imageStatusQueue.queue));
    }
}
exports.MRTesting = MRTesting;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXJfdGVzdGluZy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm1yX3Rlc3RpbmcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOztHQUVHOzs7QUFFSCw2Q0FBNEM7QUFHNUMseURBQTZEO0FBQzdELCtDQUF5RDtBQUN6RCxxRUFBeUU7QUFFekUsNkVBQW9FO0FBQ3BFLDJDQUF1QztBQUd2QyxxREFBaUQ7QUFDakQsMkRBQTBEO0FBQzFELG1EQUErQztBQUMvQyw2REFBeUQ7QUFDekQsK0RBQTBEO0FBQzFELDZDQUF3QztBQUV4Qyx5RUFBeUU7QUFDekUsaUhBQWlIO0FBQ2pILE1BQWEsZUFBZTtJQUMxQjtJQUNFLGNBQWM7SUFDUCx5QkFBeUIsa0JBQWtCLEVBQzNDLDBCQUEwQixtQkFBbUI7SUFFcEQsa0JBQWtCO0lBQ1gsd0JBQXdCLGFBQWEsRUFDckMsaUJBQWlCLE9BQU8sRUFDeEIsb0JBQW9CLFVBQVUsRUFDOUIsZUFBZSxtQkFBbUIsRUFDbEMsNEJBQTRCLENBQUMsRUFDN0IsNEJBQTRCLENBQUMsRUFDN0Isa0JBQWtCLFlBQVksRUFDOUIsdUJBQXVCLGNBQWMsRUFDckMsdUJBQXVCLGVBQWU7SUFFN0MsZUFBZTtJQUNSLG9CQUFvQixjQUFjLEVBQ2xDLGtCQUFrQixhQUFhO0lBQ3RDLHNCQUFzQjtJQUNmLHNCQUFzQixlQUFlO0lBRTVDLGlCQUFpQjtJQUNWLG1DQUFtQyw2QkFBNkIsRUFDaEUsNkJBQTZCLHVCQUF1QixFQUNwRCxnQ0FBZ0MsMEJBQTBCO0lBQ2pFLG1DQUFtQztJQUM1QixrQkFBa0IsWUFBWTtJQUNyQywyQ0FBMkM7SUFDcEMsbUJBQW1CLFlBQVk7UUEzQi9CLDJCQUFzQixHQUF0QixzQkFBc0IsQ0FBcUI7UUFDM0MsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUFzQjtRQUc3QywwQkFBcUIsR0FBckIscUJBQXFCLENBQWdCO1FBQ3JDLG1CQUFjLEdBQWQsY0FBYyxDQUFVO1FBQ3hCLHNCQUFpQixHQUFqQixpQkFB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Qyx1QkFBdUI7U0FDeEQsQ0FBQyxDQUFDO1FBRUgsaURBQWlEO1FBQ2pELEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxlQUFlLENBQ3JDLElBQUksdUNBQWUsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsS0FBSyxDQUFDLENBQ2xELENBQUM7UUFFRiwwREFBMEQ7UUFDMUQsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksc0JBQVMsQ0FBQyxJQUFJLEVBQUUsc0JBQXNCLEVBQUU7WUFDbEUsU0FBUyxFQUFFLElBQUksQ0FBQyxlQUFlLENBQUMsc0JBQXNCO1NBQ3ZELENBQUMsQ0FBQztRQUVILGdEQUFnRDtRQUNoRCxLQUFLLENBQUMsZ0JBQWdCLENBQUMsZUFBZSxDQUNwQyxJQUFJLHVDQUFlLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxDQUNqRCxDQUFDO0lBQ0osQ0FBQztDQUNGO0FBL09ELDhCQStPQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgMjAyMyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLlxuICovXG5cbmltcG9ydCB7IFJlbW92YWxQb2xpY3kgfSBmcm9tIFwiYXdzLWNkay1saWJcIjtcbmltcG9ydCB7IElWcGMgfSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWVjMlwiO1xuaW1wb3J0IHsgSVJvbGUgfSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWlhbVwiO1xuaW1wb3J0IHsgU3RyZWFtLCBTdHJlYW1Nb2RlIH0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1raW5lc2lzXCI7XG5pbXBvcnQgeyBCdWNrZXRBY2Nlc3NDb250cm9sIH0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1zM1wiO1xuaW1wb3J0IHsgQnVja2V0RGVwbG95bWVudCwgU291cmNlIH0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1zMy1kZXBsb3ltZW50XCI7XG5pbXBvcnQgeyBJVG9waWMgfSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLXNuc1wiO1xuaW1wb3J0IHsgU3FzU3Vic2NyaXB0aW9uIH0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1zbnMtc3Vic2NyaXB0aW9uc1wiO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcblxuaW1wb3J0IHsgT1NNTEFjY291bnQgfSBmcm9tIFwiLi4vb3NtbC9vc21sX2FjY291bnRcIjtcbmltcG9ydCB7IE9TTUxCdWNrZXQgfSBmcm9tIFwiLi4vb3NtbC9vc21sX2J1Y2tldFwiO1xuaW1wb3J0IHsgT1NNTEVDUkNvbnRhaW5lciB9IGZyb20gXCIuLi9vc21sL29zbWxfY29udGFpbmVyXCI7XG5pbXBvcnQgeyBPU01MUXVldWUgfSBmcm9tIFwiLi4vb3NtbC9vc21sX3F1ZXVlXCI7XG5pbXBvcnQgeyBPU01MUmVwb3NpdG9yeSB9IGZyb20gXCIuLi9vc21sL29zbWxfcmVwb3NpdG9yeVwiO1xuaW1wb3J0IHsgT1NNTFNNRW5kcG9pbnQgfSBmcm9tIFwiLi4vb3NtbC9vc21sX3NtX2VuZHBvaW50XCI7XG5pbXBvcnQgeyBNUlNNUm9sZSB9IGZyb20gXCIuL21yX3NtX3JvbGVcIjtcblxuLy8gbXV0YWJsZSBjb25maWd1cmF0aW9uIGRhdGFjbGFzcyBmb3IgdGhlIG1vZGVsIHJ1bm5lciB0ZXN0aW5nIENvbnN0cnVjdFxuLy8gZm9yIGEgbW9yZSBkZXRhaWxlZCBicmVha2Rvd24gb2YgdGhlIGNvbmZpZ3VyYXRpb24gc2VlOiBjb25maWd1cmF0aW9uX2d1aWRlLm1kIGluIHRoZSBkb2N1bWVudGF0aW9uIGRpcmVjdG9yeS5cbmV4cG9ydCBjbGFzcyBNUlRlc3RpbmdDb25maWcge1xuICBjb25zdHJ1Y3RvcihcbiAgICAvLyBxdWV1ZSBuYW1lc1xuICAgIHB1YmxpYyBTUVNfSU1BR0VfU1RBVFVTX1FVRVVFID0gXCJJbWFnZVN0YXR1c1F1ZXVlXCIsXG4gICAgcHVibGljIFNRU19SRUdJT05fU1RBVFVTX1FVRVVFID0gXCJSZWdpb25TdGF0dXNRdWV1ZVwiLFxuXG4gICAgLy8gc2FnZW1ha2VyIG5hbWVzXG4gICAgcHVibGljIFNNX0NFTlRFUl9QT0lOVF9NT0RFTCA9IFwiY2VudGVycG9pbnRcIixcbiAgICBwdWJsaWMgU01fRkxPT0RfTU9ERUwgPSBcImZsb29kXCIsXG4gICAgcHVibGljIFNNX0FJUkNSQUZUX01PREVMID0gXCJhaXJjcmFmdFwiLFxuICAgIHB1YmxpYyBTTV9ST0xFX05BTUUgPSBcIk9TTUxTYWdlTWFrZXJSb2xlXCIsXG4gICAgcHVibGljIFNNX0lOSVRJQUxfSU5TVEFOQ0VfQ09VTlQgPSAxLFxuICAgIHB1YmxpYyBTTV9JTklUSUFMX1ZBUklBTlRfV0VJR0hUID0gMSxcbiAgICBwdWJsaWMgU01fVkFSSUFOVF9OQU1FID0gXCJBbGxUcmFmZmljXCIsXG4gICAgcHVibGljIFNNX0NQVV9JTlNUQU5DRV9UWVBFID0gXCJtbC5tNS54bGFyZ2VcIixcbiAgICBwdWJsaWMgU01fR1BVX0lOU1RBTkNFX1RZUEUgPSBcIm1sLnAzLjJ4bGFyZ2VcIixcblxuICAgIC8vIGJ1Y2tldCBuYW1lc1xuICAgIHB1YmxpYyBTM19SRVNVTFRTX0JVQ0tFVCA9IFwidGVzdC1yZXN1bHRzXCIsXG4gICAgcHVibGljIFMzX0lNQUdFX0JVQ0tFVCA9IFwidGVzdC1pbWFnZXNcIixcbiAgICAvLyBwYXRoIHRvIHRlc3QgaW1hZ2VzXG4gICAgcHVibGljIFMzX1RFU1RfSU1BR0VTX1BBVEggPSBcImFzc2V0cy9pbWFnZXNcIixcblxuICAgIC8vIGVjciByZXBvIG5hbWVzXG4gICAgcHVibGljIEVDUl9DRU5URVJQT0lOVF9NT0RFTF9SRVBPU0lUT1JZID0gXCJjZW50ZXJwb2ludC1tb2RlbC1jb250YWluZXJcIixcbiAgICBwdWJsaWMgRUNSX0ZMT09EX01PREVMX1JFUE9TSVRPUlkgPSBcImZsb29kLW1vZGVsLWNvbnRhaW5lclwiLFxuICAgIHB1YmxpYyBFQ1JfQUlSQ1JBRlRfTU9ERUxfUkVQT1NJVE9SWSA9IFwiYWlyY3JhZnQtbW9kZWwtY29udGFpbmVyXCIsXG4gICAgLy8gcGF0aCB0byB0aGUgY29udHJvbCBtb2RlbCBzb3VyY2VcbiAgICBwdWJsaWMgRUNSX01PREVMU19QQVRIID0gXCJsaWIvbW9kZWxzXCIsXG4gICAgLy8gYnVpbGQgdGFyZ2V0IGZvciBjb250cm9sIG1vZGVsIGNvbnRhaW5lclxuICAgIHB1YmxpYyBFQ1JfTU9ERUxfVEFSR0VUID0gXCJvc21sX21vZGVsXCJcbiAgKSB7fVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIE1SVGVzdGluZ1Byb3BzIHtcbiAgLy8gdGhlIG9zbWwgYWNjb3VudCBpbnRlcmZhY2VcbiAgYWNjb3VudDogT1NNTEFjY291bnQ7XG4gIC8vIHRoZSBtb2RlbCBydW5uZXIgdnBjXG4gIHZwYzogSVZwYztcbiAgLy8gdGhlIG1vZGVsIHJ1bm5lciBpbWFnZSBzdGF0dXMgdG9waWNcbiAgaW1hZ2VTdGF0dXNUb3BpYzogSVRvcGljO1xuICAvLyB0aGUgbW9kZWwgcnVubmVyIHJlZ2lvbiBzdGF0dXMgdG9waWNcbiAgcmVnaW9uU3RhdHVzVG9waWM6IElUb3BpYztcbiAgLy8gb3B0aW9uYWwgY3VzdG9tIGNvbmZpZ3VyYXRpb24gZm9yIHRoZSB0ZXN0aW5nIHJlc291cmNlcyAtIHdpbGwgYmUgZGVmYXVsdGVkIGlmIG5vdCBwcm92aWRlZFxuICBtclRlc3RpbmdDb25maWc/OiBNUlRlc3RpbmdDb25maWc7XG4gIC8vIG9wdGlvbmFsIHNhZ2UgbWFrZXIgaWFtIHJvbGUgdG8gdXNlIGZvciBlbmRwb2ludCBjb25zdHJ1Y3Rpb24gLSB3aWxsIGJlIGRlZmF1bHRlZCBpZiBub3QgcHJvdmlkZWRcbiAgc21Sb2xlPzogSVJvbGU7XG4gIC8vIG9wdGlvbmFsIGN1c3RvbSBtb2RlbCBjb250YWluZXIgRUNSIFVSSXNcbiAgY2VudGVycG9pbnRNb2RlbFVyaT86IHN0cmluZztcbiAgZmxvb2RNb2RlbFVyaT86IHN0cmluZztcbiAgYWlyY3JhZnRNb2RlbFVyaT86IHN0cmluZztcblxuICAvLyBvcHRpb25hbCBkZXBsb3kgY3VzdG9tIG1vZGVsIHJlc291cmNlc1xuICBkZXBsb3lDZW50ZXJwb2ludE1vZGVsPzogYm9vbGVhbjtcbiAgZGVwbG95Rmxvb2RNb2RlbD86IGJvb2xlYW47XG4gIGRlcGxveUFpcmNyYWZ0TW9kZWw/OiBib29sZWFuO1xufVxuXG5leHBvcnQgY2xhc3MgTVJUZXN0aW5nIGV4dGVuZHMgQ29uc3RydWN0IHtcbiAgcHVibGljIHJlc3VsdHNCdWNrZXQ6IE9TTUxCdWNrZXQ7XG4gIHB1YmxpYyBpbWFnZUJ1Y2tldDogT1NNTEJ1Y2tldDtcbiAgcHVibGljIHJlc3VsdFN0cmVhbTogU3RyZWFtO1xuICBwdWJsaWMgY2VudGVyUG9pbnRNb2RlbEVuZHBvaW50OiBPU01MU01FbmRwb2ludDtcbiAgcHVibGljIGNlbnRlclBvaW50TW9kZWxSZXBvc2l0b3J5OiBPU01MUmVwb3NpdG9yeTtcbiAgcHVibGljIGNlbnRlclBvaW50TW9kZWxJbWFnZUFzc2V0OiBzdHJpbmc7XG4gIHB1YmxpYyBmbG9vZE1vZGVsUmVwb3NpdG9yeTogT1NNTFJlcG9zaXRvcnk7XG4gIHB1YmxpYyBmbG9vZE1vZGVsSW1hZ2VBc3NldDogc3RyaW5nO1xuICBwdWJsaWMgZmxvb2RNb2RlbEVuZHBvaW50OiBPU01MU01FbmRwb2ludDtcbiAgcHVibGljIGFpcmNyYWZ0TW9kZWxSZXBvc2l0b3J5OiBPU01MUmVwb3NpdG9yeTtcbiAgcHVibGljIGFpcmNyYWZ0TW9kZWxJbWFnZUFzc2V0OiBzdHJpbmc7XG4gIHB1YmxpYyBhaXJjcmFmdE1vZGVsRW5kcG9pbnQ6IE9TTUxTTUVuZHBvaW50O1xuICBwdWJsaWMgaW1hZ2VTdGF0dXNRdWV1ZTogT1NNTFF1ZXVlO1xuICBwdWJsaWMgcmVnaW9uU3RhdHVzUXVldWU6IE9TTUxRdWV1ZTtcbiAgcHVibGljIHJlbW92YWxQb2xpY3k6IFJlbW92YWxQb2xpY3k7XG4gIHB1YmxpYyBzbVJvbGU/OiBJUm9sZTtcbiAgcHVibGljIG1yVGVzdGluZ0NvbmZpZzogTVJUZXN0aW5nQ29uZmlnO1xuXG4gIC8qKlxuICAgKiBDcmVhdGVzIGFuIE1SVGVzdGluZyBjb25zdHJ1Y3QuXG4gICAqIEBwYXJhbSBzY29wZSB0aGUgc2NvcGUvc3RhY2sgaW4gd2hpY2ggdG8gZGVmaW5lIHRoaXMgY29uc3RydWN0LlxuICAgKiBAcGFyYW0gaWQgdGhlIGlkIG9mIHRoaXMgY29uc3RydWN0IHdpdGhpbiB0aGUgY3VycmVudCBzY29wZS5cbiAgICogQHBhcmFtIHByb3BzIHRoZSBwcm9wZXJ0aWVzIG9mIHRoaXMgY29uc3RydWN0LlxuICAgKiBAcmV0dXJucyB0aGUgTVJUZXN0aW5nIGNvbnN0cnVjdC5cbiAgICovXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBNUlRlc3RpbmdQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICAvLyBjaGVjayBpZiBhIGN1c3RvbSBjb25maWcgd2FzIHByb3ZpZGVkXG4gICAgaWYgKHByb3BzLm1yVGVzdGluZ0NvbmZpZyAhPSB1bmRlZmluZWQpIHtcbiAgICAgIC8vIGltcG9ydCBleGlzdGluZyBwYXNzIGluIE1SIGNvbmZpZ3VyYXRpb25cbiAgICAgIHRoaXMubXJUZXN0aW5nQ29uZmlnID0gcHJvcHMubXJUZXN0aW5nQ29uZmlnO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBjcmVhdGUgYSBuZXcgZGVmYXVsdCBjb25maWd1cmF0aW9uXG4gICAgICB0aGlzLm1yVGVzdGluZ0NvbmZpZyA9IG5ldyBNUlRlc3RpbmdDb25maWcoKTtcbiAgICB9XG5cbiAgICAvLyBzZXR1cCBhIHJlbW92YWwgcG9saWN5XG4gICAgdGhpcy5yZW1vdmFsUG9saWN5ID0gcHJvcHMuYWNjb3VudC5wcm9kTGlrZVxuICAgICAgPyBSZW1vdmFsUG9saWN5LlJFVEFJTlxuICAgICAgOiBSZW1vdmFsUG9saWN5LkRFU1RST1k7XG5cbiAgICAvLyBidWNrZXQgdG8gc3RvcmUgaW1hZ2VzIGluXG4gICAgdGhpcy5pbWFnZUJ1Y2tldCA9IG5ldyBPU01MQnVja2V0KHRoaXMsIGBPU01MVGVzdEltYWdlQnVja2V0YCwge1xuICAgICAgYnVja2V0TmFtZTogYCR7dGhpcy5tclRlc3RpbmdDb25maWcuUzNfSU1BR0VfQlVDS0VUfS0ke3Byb3BzLmFjY291bnQuaWR9YCxcbiAgICAgIHByb2RMaWtlOiBwcm9wcy5hY2NvdW50LnByb2RMaWtlLFxuICAgICAgcmVtb3ZhbFBvbGljeTogdGhpcy5yZW1vdmFsUG9saWN5XG4gICAgfSk7XG5cbiAgICAvLyBkZXBsb3kgdGVzdCBpbWFnZXMgaW50byBidWNrZXRcbiAgICBuZXcgQnVja2V0RGVwbG95bWVudCh0aGlzLCBcIk9TTUxUZXN0SW1hZ2VEZXBsb3ltZW50XCIsIHtcbiAgICAgIHNvdXJjZXM6IFtTb3VyY2UuYXNzZXQodGhpcy5tclRlc3RpbmdDb25maWcuUzNfVEVTVF9JTUFHRVNfUEFUSCldLFxuICAgICAgZGVzdGluYXRpb25CdWNrZXQ6IHRoaXMuaW1hZ2VCdWNrZXQuYnVja2V0LFxuICAgICAgYWNjZXNzQ29udHJvbDogQnVja2V0QWNjZXNzQ29udHJvbC5CVUNLRVRfT1dORVJfRlVMTF9DT05UUk9MLFxuICAgICAgbWVtb3J5TGltaXQ6IDEwMjQwLFxuICAgICAgdXNlRWZzOiB0cnVlLFxuICAgICAgdnBjOiBwcm9wcy52cGNcbiAgICB9KTtcblxuICAgIC8vIGJ1Y2tldCB0byBzdG9yZSByZXN0IHJlc3VsdHMgaW5cbiAgICB0aGlzLnJlc3VsdHNCdWNrZXQgPSBuZXcgT1NNTEJ1Y2tldCh0aGlzLCBgT1NNTFRlc3RSZXN1bHRzQnVja2V0YCwge1xuICAgICAgYnVja2V0TmFtZTogYCR7dGhpcy5tclRlc3RpbmdDb25maWcuUzNfUkVTVUxUU19CVUNLRVR9LSR7cHJvcHMuYWNjb3VudC5pZH1gLFxuICAgICAgcHJvZExpa2U6IHByb3BzLmFjY291bnQucHJvZExpa2UsXG4gICAgICByZW1vdmFsUG9saWN5OiB0aGlzLnJlbW92YWxQb2xpY3lcbiAgICB9KTtcblxuICAgIC8vIGEgc2ltcGxlIHByb3Zpc2lvbmVkIHN0cmVhbSBmb3IgdGVzdGluZyB0aGUga2luZXNpcyBzaW5rXG4gICAgdGhpcy5yZXN1bHRTdHJlYW0gPSBuZXcgU3RyZWFtKHRoaXMsIFwiVGVzdFN0cmVhbVwiLCB7XG4gICAgICBzdHJlYW1OYW1lOiBgdGVzdC1zdHJlYW0tJHtwcm9wcy5hY2NvdW50LmlkfWAsXG4gICAgICBzdHJlYW1Nb2RlOiBTdHJlYW1Nb2RlLlBST1ZJU0lPTkVELFxuICAgICAgc2hhcmRDb3VudDogMVxuICAgIH0pO1xuXG4gICAgLy8gY2hlY2sgaWYgYSByb2xlIHdhcyBwcm92aWRlZFxuICAgIGlmIChwcm9wcy5zbVJvbGUgIT0gdW5kZWZpbmVkKSB7XG4gICAgICAvLyBpbXBvcnQgcGFzc2VkIGluIE1SIHRhc2sgcm9sZVxuICAgICAgdGhpcy5zbVJvbGUgPSBwcm9wcy5zbVJvbGU7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIGNyZWF0ZSBhIG5ldyByb2xlXG4gICAgICB0aGlzLnNtUm9sZSA9IG5ldyBNUlNNUm9sZSh0aGlzLCBcIk1SU01Sb2xlXCIsIHtcbiAgICAgICAgYWNjb3VudDogcHJvcHMuYWNjb3VudCxcbiAgICAgICAgcm9sZU5hbWU6IHRoaXMubXJUZXN0aW5nQ29uZmlnLlNNX1JPTEVfTkFNRVxuICAgICAgfSkucm9sZTtcbiAgICB9XG5cbiAgICBpZiAocHJvcHMuZGVwbG95Q2VudGVycG9pbnRNb2RlbCAhPSBmYWxzZSkge1xuICAgICAgaWYgKHByb3BzLmNlbnRlcnBvaW50TW9kZWxVcmkgIT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIC8vIGltcG9ydCB0aGUgaW1hZ2UgYXNzZXQgcGFzc2VkIGluXG4gICAgICAgIHRoaXMuY2VudGVyUG9pbnRNb2RlbEltYWdlQXNzZXQgPSBwcm9wcy5jZW50ZXJwb2ludE1vZGVsVXJpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gYnVpbGQgYSBuZXcgcmVwb3NpdG9yeSBmb3IgdGhlIGNlbnRlcnBvaW50IG1vZGVsXG4gICAgICAgIHRoaXMuY2VudGVyUG9pbnRNb2RlbFJlcG9zaXRvcnkgPSBuZXcgT1NNTFJlcG9zaXRvcnkoXG4gICAgICAgICAgdGhpcyxcbiAgICAgICAgICBcIk1SQ2VudGVycG9pbnRNb2RlbFJlcG9zaXRvcnlcIixcbiAgICAgICAgICB7XG4gICAgICAgICAgICByZXBvc2l0b3J5TmFtZTpcbiAgICAgICAgICAgICAgdGhpcy5tclRlc3RpbmdDb25maWcuRUNSX0NFTlRFUlBPSU5UX01PREVMX1JFUE9TSVRPUlksXG4gICAgICAgICAgICByZW1vdmFsUG9saWN5OiB0aGlzLnJlbW92YWxQb2xpY3lcbiAgICAgICAgICB9XG4gICAgICAgICk7XG5cbiAgICAgICAgLy8gYnVpbGQgYW5kIGRlcGxveSBjZW50ZXJwb2ludCBtb2RlbCBjb250YWluZXIgdG8gdGFyZ2V0IHJlcG9cbiAgICAgICAgdGhpcy5jZW50ZXJQb2ludE1vZGVsSW1hZ2VBc3NldCA9IG5ldyBPU01MRUNSQ29udGFpbmVyKFxuICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgXCJNUkNlbnRlclBvaW50TW9kZWxDb250YWluZXJcIixcbiAgICAgICAgICB7XG4gICAgICAgICAgICBkaXJlY3Rvcnk6IHRoaXMubXJUZXN0aW5nQ29uZmlnLkVDUl9NT0RFTFNfUEFUSCxcbiAgICAgICAgICAgIHRhcmdldDogdGhpcy5tclRlc3RpbmdDb25maWcuRUNSX01PREVMX1RBUkdFVCxcbiAgICAgICAgICAgIHJlcG9zaXRvcnk6IHRoaXMuY2VudGVyUG9pbnRNb2RlbFJlcG9zaXRvcnkucmVwb3NpdG9yeSxcbiAgICAgICAgICAgIGJ1aWxkQXJnczogeyBNT0RFTF9TRUxFQ1RJT046IFwiY2VudGVycG9pbnRcIiB9XG4gICAgICAgICAgfVxuICAgICAgICApLmltYWdlQXNzZXQuaW1hZ2VVcmk7XG4gICAgICB9XG5cbiAgICAgIC8vIGJ1aWxkIGFuIFNNIGVuZHBvaW50IGZyb20gdGhlIGNlbnRlcnBvaW50IG1vZGVsIGNvbnRhaW5lclxuICAgICAgdGhpcy5jZW50ZXJQb2ludE1vZGVsRW5kcG9pbnQgPSBuZXcgT1NNTFNNRW5kcG9pbnQoXG4gICAgICAgIHRoaXMsXG4gICAgICAgIFwiT1NNTENlbnRlclBvaW50TW9kZWxFbmRwb2ludFwiLFxuICAgICAgICB7XG4gICAgICAgICAgbW9kZWxDb250YWluZXJVcmk6IHRoaXMuY2VudGVyUG9pbnRNb2RlbEltYWdlQXNzZXQsXG4gICAgICAgICAgbW9kZWxOYW1lOiB0aGlzLm1yVGVzdGluZ0NvbmZpZy5TTV9DRU5URVJfUE9JTlRfTU9ERUwsXG4gICAgICAgICAgcm9sZUFybjogdGhpcy5zbVJvbGUucm9sZUFybixcbiAgICAgICAgICBpbnN0YW5jZVR5cGU6IHRoaXMubXJUZXN0aW5nQ29uZmlnLlNNX0NQVV9JTlNUQU5DRV9UWVBFLFxuICAgICAgICAgIGluaXRpYWxJbnN0YW5jZUNvdW50OiB0aGlzLm1yVGVzdGluZ0NvbmZpZy5TTV9JTklUSUFMX0lOU1RBTkNFX0NPVU5ULFxuICAgICAgICAgIGluaXRpYWxWYXJpYW50V2VpZ2h0OiB0aGlzLm1yVGVzdGluZ0NvbmZpZy5TTV9JTklUSUFMX1ZBUklBTlRfV0VJR0hULFxuICAgICAgICAgIHZhcmlhbnROYW1lOiB0aGlzLm1yVGVzdGluZ0NvbmZpZy5TTV9WQVJJQU5UX05BTUVcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAocHJvcHMuZGVwbG95Rmxvb2RNb2RlbCAhPSBmYWxzZSkge1xuICAgICAgaWYgKHByb3BzLmZsb29kTW9kZWxVcmkgIT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIC8vIGltcG9ydCB0aGUgaW1hZ2UgYXNzZXQgcGFzc2VkIGluXG4gICAgICAgIHRoaXMuZmxvb2RNb2RlbEltYWdlQXNzZXQgPSBwcm9wcy5mbG9vZE1vZGVsVXJpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gYnVpbGQgYSBuZXcgcmVwb3NpdG9yeSBmb3IgdGhlIGZsb29kIG1vZGVsXG4gICAgICAgIHRoaXMuZmxvb2RNb2RlbFJlcG9zaXRvcnkgPSBuZXcgT1NNTFJlcG9zaXRvcnkoXG4gICAgICAgICAgdGhpcyxcbiAgICAgICAgICBcIk1SRmxvb2RNb2RlbFJlcG9zaXRvcnlcIixcbiAgICAgICAgICB7XG4gICAgICAgICAgICByZXBvc2l0b3J5TmFtZTogdGhpcy5tclRlc3RpbmdDb25maWcuRUNSX0ZMT09EX01PREVMX1JFUE9TSVRPUlksXG4gICAgICAgICAgICByZW1vdmFsUG9saWN5OiB0aGlzLnJlbW92YWxQb2xpY3lcbiAgICAgICAgICB9XG4gICAgICAgICk7XG5cbiAgICAgICAgLy8gYnVpbGQgYW5kIGRlcGxveSBmbG9vZCBtb2RlbCBjb250YWluZXIgdG8gdGFyZ2V0IHJlcG9cbiAgICAgICAgdGhpcy5mbG9vZE1vZGVsSW1hZ2VBc3NldCA9IG5ldyBPU01MRUNSQ29udGFpbmVyKFxuICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgXCJNUkZsb29kTW9kZWxDb250YWluZXJcIixcbiAgICAgICAgICB7XG4gICAgICAgICAgICBkaXJlY3Rvcnk6IHRoaXMubXJUZXN0aW5nQ29uZmlnLkVDUl9NT0RFTFNfUEFUSCxcbiAgICAgICAgICAgIHRhcmdldDogdGhpcy5tclRlc3RpbmdDb25maWcuRUNSX01PREVMX1RBUkdFVCxcbiAgICAgICAgICAgIHJlcG9zaXRvcnk6IHRoaXMuZmxvb2RNb2RlbFJlcG9zaXRvcnkucmVwb3NpdG9yeSxcbiAgICAgICAgICAgIGJ1aWxkQXJnczogeyBNT0RFTF9TRUxFQ1RJT046IFwiZmxvb2RcIiB9XG4gICAgICAgICAgfVxuICAgICAgICApLmltYWdlQXNzZXQuaW1hZ2VVcmk7XG4gICAgICB9XG5cbiAgICAgIC8vIGJ1aWxkIGFuIFNNIGVuZHBvaW50IGZyb20gdGhlIGZsb29kIG1vZGVsIGNvbnRhaW5lclxuICAgICAgdGhpcy5mbG9vZE1vZGVsRW5kcG9pbnQgPSBuZXcgT1NNTFNNRW5kcG9pbnQoXG4gICAgICAgIHRoaXMsXG4gICAgICAgIFwiT1NNTEZsb29kTW9kZWxFbmRwb2ludFwiLFxuICAgICAgICB7XG4gICAgICAgICAgbW9kZWxDb250YWluZXJVcmk6IHRoaXMuZmxvb2RNb2RlbEltYWdlQXNzZXQsXG4gICAgICAgICAgbW9kZWxOYW1lOiB0aGlzLm1yVGVzdGluZ0NvbmZpZy5TTV9GTE9PRF9NT0RFTCxcbiAgICAgICAgICByb2xlQXJuOiB0aGlzLnNtUm9sZS5yb2xlQXJuLFxuICAgICAgICAgIGluc3RhbmNlVHlwZTogdGhpcy5tclRlc3RpbmdDb25maWcuU01fQ1BVX0lOU1RBTkNFX1RZUEUsXG4gICAgICAgICAgaW5pdGlhbEluc3RhbmNlQ291bnQ6IHRoaXMubXJUZXN0aW5nQ29uZmlnLlNNX0lOSVRJQUxfSU5TVEFOQ0VfQ09VTlQsXG4gICAgICAgICAgaW5pdGlhbFZhcmlhbnRXZWlnaHQ6IHRoaXMubXJUZXN0aW5nQ29uZmlnLlNNX0lOSVRJQUxfVkFSSUFOVF9XRUlHSFQsXG4gICAgICAgICAgdmFyaWFudE5hbWU6IHRoaXMubXJUZXN0aW5nQ29uZmlnLlNNX1ZBUklBTlRfTkFNRVxuICAgICAgICB9XG4gICAgICApO1xuICAgIH1cblxuICAgIGlmIChwcm9wcy5kZXBsb3lBaXJjcmFmdE1vZGVsICE9IGZhbHNlKSB7XG4gICAgICBpZiAocHJvcHMuYWlyY3JhZnRNb2RlbFVyaSAhPSB1bmRlZmluZWQpIHtcbiAgICAgICAgLy8gaW1wb3J0IHRoZSBpbWFnZSBhc3NldCBwYXNzZWQgaW5cbiAgICAgICAgdGhpcy5haXJjcmFmdE1vZGVsSW1hZ2VBc3NldCA9IHByb3BzLmFpcmNyYWZ0TW9kZWxVcmk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBidWlsZCBhIG5ldyByZXBvc2l0b3J5IGZvciB0aGUgYWlyY3JhZnQgbW9kZWxcbiAgICAgICAgdGhpcy5haXJjcmFmdE1vZGVsUmVwb3NpdG9yeSA9IG5ldyBPU01MUmVwb3NpdG9yeShcbiAgICAgICAgICB0aGlzLFxuICAgICAgICAgIFwiTVJBaXJjcmFmdE1vZGVsUmVwb3NpdG9yeVwiLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIHJlcG9zaXRvcnlOYW1lOiB0aGlzLm1yVGVzdGluZ0NvbmZpZy5FQ1JfQUlSQ1JBRlRfTU9ERUxfUkVQT1NJVE9SWSxcbiAgICAgICAgICAgIHJlbW92YWxQb2xpY3k6IHRoaXMucmVtb3ZhbFBvbGljeVxuICAgICAgICAgIH1cbiAgICAgICAgKTtcblxuICAgICAgICAvLyBidWlsZCBhbmQgZGVwbG95IGFpY3JhZnQgbW9kZWwgY29udGFpbmVyIHRvIHRhcmdldCByZXBvXG4gICAgICAgIHRoaXMuYWlyY3JhZnRNb2RlbEltYWdlQXNzZXQgPSBuZXcgT1NNTEVDUkNvbnRhaW5lcihcbiAgICAgICAgICB0aGlzLFxuICAgICAgICAgIFwiTVJBaXJjcmFmdE1vZGVsQ29udGFpbmVyXCIsXG4gICAgICAgICAge1xuICAgICAgICAgICAgZGlyZWN0b3J5OiB0aGlzLm1yVGVzdGluZ0NvbmZpZy5FQ1JfTU9ERUxTX1BBVEgsXG4gICAgICAgICAgICB0YXJnZXQ6IHRoaXMubXJUZXN0aW5nQ29uZmlnLkVDUl9NT0RFTF9UQVJHRVQsXG4gICAgICAgICAgICByZXBvc2l0b3J5OiB0aGlzLmFpcmNyYWZ0TW9kZWxSZXBvc2l0b3J5LnJlcG9zaXRvcnksXG4gICAgICAgICAgICBidWlsZEFyZ3M6IHsgTU9ERUxfU0VMRUNUSU9OOiBcImFpcmNyYWZ0XCIgfVxuICAgICAgICAgIH1cbiAgICAgICAgKS5pbWFnZUFzc2V0LmltYWdlVXJpO1xuICAgICAgfVxuXG4gICAgICAvLyBidWlsZCBhbiBTTSBlbmRwb2ludCBmcm9tIHRoZSBhaXJjcmFmdCBtb2RlbCBjb250YWluZXJcbiAgICAgIHRoaXMuYWlyY3JhZnRNb2RlbEVuZHBvaW50ID0gbmV3IE9TTUxTTUVuZHBvaW50KFxuICAgICAgICB0aGlzLFxuICAgICAgICBcIk9TTUxBaXJjcmFmdE1vZGVsRW5kcG9pbnRcIixcbiAgICAgICAge1xuICAgICAgICAgIG1vZGVsQ29udGFpbmVyVXJpOiB0aGlzLmFpcmNyYWZ0TW9kZWxJbWFnZUFzc2V0LFxuICAgICAgICAgIG1vZGVsTmFtZTogdGhpcy5tclRlc3RpbmdDb25maWcuU01fQUlSQ1JBRlRfTU9ERUwsXG4gICAgICAgICAgcm9sZUFybjogdGhpcy5zbVJvbGUucm9sZUFybixcbiAgICAgICAgICBpbnN0YW5jZVR5cGU6IHRoaXMubXJUZXN0aW5nQ29uZmlnLlNNX0dQVV9JTlNUQU5DRV9UWVBFLFxuICAgICAgICAgIGluaXRpYWxJbnN0YW5jZUNvdW50OiB0aGlzLm1yVGVzdGluZ0NvbmZpZy5TTV9JTklUSUFMX0lOU1RBTkNFX0NPVU5ULFxuICAgICAgICAgIGluaXRpYWxWYXJpYW50V2VpZ2h0OiB0aGlzLm1yVGVzdGluZ0NvbmZpZy5TTV9JTklUSUFMX1ZBUklBTlRfV0VJR0hULFxuICAgICAgICAgIHZhcmlhbnROYW1lOiB0aGlzLm1yVGVzdGluZ0NvbmZpZy5TTV9WQVJJQU5UX05BTUVcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBjcmVhdGUgYW4gU1FTIHF1ZXVlIGZvciByZWdpb24gc3RhdHVzIHByb2Nlc3NpbmcgdXBkYXRlc1xuICAgIHRoaXMucmVnaW9uU3RhdHVzUXVldWUgPSBuZXcgT1NNTFF1ZXVlKHRoaXMsIFwiT1NNTFJlZ2lvblN0YXR1c1F1ZXVlXCIsIHtcbiAgICAgIHF1ZXVlTmFtZTogdGhpcy5tclRlc3RpbmdDb25maWcuU1FTX1JFR0lPTl9TVEFUVVNfUVVFVUVcbiAgICB9KTtcblxuICAgIC8vIHN1YnNjcmliZSB0aGUgcmVnaW9uIHN0YXR1cyB0b3BpYyB0byB0aGUgcXVldWVcbiAgICBwcm9wcy5yZWdpb25TdGF0dXNUb3BpYy5hZGRTdWJzY3JpcHRpb24oXG4gICAgICBuZXcgU3FzU3Vic2NyaXB0aW9uKHRoaXMucmVnaW9uU3RhdHVzUXVldWUucXVldWUpXG4gICAgKTtcblxuICAgIC8vIGNyZWF0ZSBhbiBTUVMgcXVldWUgZm9yIGltYWdlIHByb2Nlc3Npbmcgc3RhdHVzIHVwZGF0ZXNcbiAgICB0aGlzLmltYWdlU3RhdHVzUXVldWUgPSBuZXcgT1NNTFF1ZXVlKHRoaXMsIFwiT1NNTEltYWdlU3RhdHVzUXVldWVcIiwge1xuICAgICAgcXVldWVOYW1lOiB0aGlzLm1yVGVzdGluZ0NvbmZpZy5TUVNfSU1BR0VfU1RBVFVTX1FVRVVFXG4gICAgfSk7XG5cbiAgICAvLyBzdWJzY3JpYmUgdGhlIGltYWdlIHN0YXR1cyB0b3BpYyB0byB0aGUgcXVldWVcbiAgICBwcm9wcy5pbWFnZVN0YXR1c1RvcGljLmFkZFN1YnNjcmlwdGlvbihcbiAgICAgIG5ldyBTcXNTdWJzY3JpcHRpb24odGhpcy5pbWFnZVN0YXR1c1F1ZXVlLnF1ZXVlKVxuICAgICk7XG4gIH1cbn1cbiJdfQ==